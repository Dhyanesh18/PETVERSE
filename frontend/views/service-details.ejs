<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= pageTitle %></title>

  <link rel="stylesheet" href="/css/services.css">
  <link rel="stylesheet" href="/css/service-details.css">
  <link rel="stylesheet" href="/css/styles.css"> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/homepage.css">
  <style>
    .service-detail-container {
      max-width: 1200px;
      margin: 120px auto 30px;
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    
    .service-header {
      display: flex;
      align-items: flex-start;
      margin-bottom: 30px;
      gap: 30px;
    }
    
    .service-image {
      width: 300px;
      height: 300px;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .service-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .service-info {
      flex: 1;
    }
    
    .service-name {
      font-size: 2.5rem;
      color: #333;
      margin-bottom: 10px;
    }
    
    .service-category {
      display: inline-block;
      background-color: #4CAF50;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 1rem;
      margin-bottom: 15px;
    }
    
    .service-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .meta-item i {
      color: #4CAF50;
    }
    
    .service-description {
      margin: 20px 0;
      line-height: 1.6;
      color: #555;
    }
    
    .pricing {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .pricing h3 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .price-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #ddd;
    }
    
    .booking-section {
      margin-top: 30px;
      text-align: center;
    }
    
    .book-button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 1.1rem;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    
    .book-button:hover {
      background-color: #388e3c;
    }
    
    .reviews-section {
      margin-top: 40px;
    }
    
    .reviews-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .review-card {
      padding: 15px;
      border-radius: 8px;
      background-color: #f8f9fa;
      margin-bottom: 15px;
    }
    
    .review-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .review-author {
      font-weight: bold;
    }
    
    .star-rating {
      color: #ffc107;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: auto;
    }
    
    .modal-content {
      background-color: #fff;
      margin: 50px auto;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      position: relative;
      padding: 30px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      color: #777;
      cursor: pointer;
      transition: color 0.3s;
    }
    
    .close-modal:hover {
      color: #f44336;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .rating-select {
      display: flex;
      gap: 10px;
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .rating-select i {
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .rating-select i:hover {
      transform: scale(1.2);
    }
    
    .rating-select i.fas {
      color: #ffc107;
    }
    
    .rating-select i.far {
      color: #ddd;
    }
    
    #review-comment {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Poppins', sans-serif;
      resize: vertical;
    }
    
    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .service-header {
        flex-direction: column;
      }
      .service-image {
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
      }
      .reviews-header {
        flex-direction: column;
        gap: 15px;
      }
    }
  </style>
</head>
<body data-user-logged-in="<%= locals.user ? 'true' : 'false' %>" data-service-id="<%= service.id %>">
    <header class="header">
        <nav id="navbar" class="navbar">
            <div class="nav-content">
                <div class="logo"><a href="/"><i class="fa fa-paw"></i> PetVerse</a></div>
                <div class="nav-icons">
                    <a href="/cart" class="icon-btn cart-icon" id="cartIcon">
                        <i class="fa fa-shopping-cart"></i>
                        <span class="cart-count" id="cartCount" style="display: none;">0</span>
                    </a>
                    <a href="/login" class="icon-btn"><i class="fa fa-user"></i></a>
                </div>
                <div class="search">
                    <input class="search-bar" type="text" placeholder="Search pets, products or services">
                    <button class="search-btn"><i class="fa fa-search"></i></button>
                </div>
                <button class="hamburger" id="hamburger">
                    <i class="fa fa-bars"></i>
                </button>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href="/about">About</a></li>
                    <li><a href="/pets">Pets</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle">Products <i class="fa fa-angle-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="/products/petfood">Pet Food</a></li>
                            <li><a href="/products/toys">Toys</a></li>
                            <li><a href="/products/accessories">Accessories</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle">Services <i class="fa fa-angle-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="/services">Services</a></li>
                            <li><a href="/mate">PetMate</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <div class="service-detail-container">
      <div id="alert-container"></div>
      
      <div class="service-header">
        <div class="service-image">
          <%
            let imagePath = '/images/services/service2.jpg';
            switch (service.category.toLowerCase()) {
              case 'veterinarian':
                imagePath = '/images/services/service1.jpg';
                break;
              case 'groomer':
                imagePath = '/images/services/service7.jpg';
                break;
              case 'pet sitter':
                imagePath = '/images/services/service11.jpg';
                break;
              case 'trainer':
                imagePath = '/images/services/service6.jpg';
                break;
              case 'breeder':
                imagePath = '/images/services/service12.jpg';
                break;
            }
          %>
          <img src="<%= imagePath %>" alt="<%= service.name %>">
        </div>
        
        <div class="service-info">
          <h1 class="service-name"><%= service.name %></h1>
          <span class="service-category"><%= service.category %></span>
          
          <div class="service-meta">
            <div class="meta-item">
              <i class="fas fa-map-marker-alt"></i>
              <span><%= service.location %></span>
            </div>
            <div class="meta-item">
              <i class="fas fa-clock"></i>
              <span>Mon-Sat, 9:00 AM - 6:00 PM</span>
            </div>
            <div class="meta-item">
              <i class="fas fa-star"></i>
              <span><span id="service-rating"><%= service.rating || 0 %></span> (<span id="review-count"><%= service.reviewCount || 0 %></span> Reviews)</span>
            </div>
          </div>
          
          <p class="service-description"><%= service.description %></p>
        </div>
      </div>
      
      <div class="pricing">
        <h3>Services & Pricing</h3>
        <% if (service.category === 'Veterinary Doctor') { %>
          <div class="price-item">
            <span>Basic Checkup</span>
            <span>₹500</span>
          </div>
          <div class="price-item">
            <span>Vaccination</span>
            <span>₹800 - ₹1,500</span>
          </div>
          <div class="price-item">
            <span>Surgery Consultation</span>
            <span>₹1,000</span>
          </div>
        <% } else if (service.category === 'Pet Grooming') { %>
          <div class="price-item">
            <span>Basic Bath & Brush</span>
            <span>₹<%= service.price || 800 %></span>
          </div>
          <div class="price-item">
            <span>Full Grooming (Bath, haircut, nails, ears)</span>
            <span>₹<%= (service.price * 1.5) || 1200 %></span>
          </div>
          <div class="price-item">
            <span>Specialized Treatments</span>
            <span>₹<%= (service.price * 2) || 1500 %>+</span>
          </div>
        <% } else if (service.category === 'Dog Training') { %>
          <div class="price-item">
            <span>Basic Obedience Training</span>
            <span>₹500 per session</span>
          </div>
          <div class="price-item">
            <span>6-Week Package</span>
            <span>₹2,500</span>
          </div>
          <div class="price-item">
            <span>Advanced Training</span>
            <span>₹4,000</span>
          </div>
        <% } else { %>
          <div class="price-item">
            <span>Standard Service</span>
            <span>₹<%= service.price || 500 %></span>
          </div>
        <% } %>
      </div>
      
      <div class="booking-section">
        <a href="/booking/<%= service.id %>" class="book-button">Book Now</a>
      </div>
      
      <div class="reviews-section">
        <div class="reviews-header">
          <h2>Client Reviews</h2>
          <% if (locals.user) { %>
            <button class="book-button" id="writeReviewBtn">Write a Review</button>
          <% } else { %>
            <a href="/login?redirect=<%= encodeURIComponent('/services/' + service.id) %>" class="book-button">Login to Review</a>
          <% } %>
        </div>
        
        <div id="reviews-container">
          <% if (service.reviews && service.reviews.length > 0) { %>
            <% service.reviews.forEach(review => { %>
              <div class="review-card">
                <div class="review-header">
                  <div class="review-author"><%= review.user ? review.user.fullName : 'Anonymous' %></div>
                  <div class="star-rating">
                    <% for (let i = 1; i <= 5; i++) { %>
                      <% if (i <= review.rating) { %>
                        <i class="fas fa-star"></i>
                      <% } else { %>
                        <i class="far fa-star"></i>
                      <% } %>
                    <% } %>
                  </div>
                </div>
                <p><%= review.comment %></p>
                <small><%= new Date(review.createdAt).toLocaleDateString() %></small>
              </div>
            <% }); %>
          <% } else { %>
            <p>No reviews yet. Be the first to review this service!</p>
          <% } %>
        </div>
      </div>
    </div>
    
    <div id="review-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Write a Review</h2>
        <form id="service-review-form">
          <div class="form-group">
            <label>Rating</label>
            <div class="rating-select">
              <i class="<%= userReview && userReview.rating >= 1 ? 'fas' : 'far' %> fa-star" data-rating="1"></i>
              <i class="<%= userReview && userReview.rating >= 2 ? 'fas' : 'far' %> fa-star" data-rating="2"></i>
              <i class="<%= userReview && userReview.rating >= 3 ? 'fas' : 'far' %> fa-star" data-rating="3"></i>
              <i class="<%= userReview && userReview.rating >= 4 ? 'fas' : 'far' %> fa-star" data-rating="4"></i>
              <i class="<%= userReview && userReview.rating >= 5 ? 'fas' : 'far' %> fa-star" data-rating="5"></i>
              <input type="hidden" id="rating-value" value="<%= userReview ? userReview.rating : '' %>" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="review-comment">Your Review</label>
            <textarea id="review-comment" rows="4" required maxlength="200"><%= userReview ? userReview.comment : '' %></textarea>
            <small><span id="char-count">0</span>/200 characters</small>
          </div>
          
          <button type="submit" class="book-button" id="submit-review-btn">
            <span id="submit-text">Submit Review</span>
            <span id="submit-loading" style="display: none;" class="loading"></span>
          </button>
        </form>
      </div>
    </div>

    <footer id="footer">
        <div class="footer-container">
            <div class="footer-logo">
                <h2>PetVerse</h2>
                <p>Your one-stop destination for all pet needs</p>
            </div>
            <div class="footer-links">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Shop</a></li>
                    <li><a href="#">Services</a></li>
                    <li><a href="#">Events</a></li>
                    <li><a href="#">Contact Us</a></li>
                </ul>
            </div>
            <div class="footer-social">
                <h3>Follow Us</h3>
                <a href="https://facebook.com" target="_blank" class="social-icon">Facebook</a>
                <a href="https://instagram.com" target="_blank" class="social-icon">Instagram</a>
                <a href="https://twitter.com" target="_blank" class="social-icon">Twitter</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 PetVerse. All Rights Reserved</p>
        </div>
    </footer>

    <script src="/js/Services.js"></script>
    
    <!-- AJAX REVIEW SCRIPT - NO ALERTS -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('review-modal');
        const writeReviewBtn = document.getElementById('writeReviewBtn');
        const closeModal = document.querySelector('.close-modal');
        const reviewForm = document.getElementById('service-review-form');
        const ratingStars = document.querySelectorAll('.rating-select i');
        const ratingValue = document.getElementById('rating-value');
        const reviewComment = document.getElementById('review-comment');
        const charCount = document.getElementById('char-count');
        const submitBtn = document.getElementById('submit-review-btn');
        const submitText = document.getElementById('submit-text');
        const submitLoading = document.getElementById('submit-loading');
        const serviceId = document.body.getAttribute('data-service-id');
        
        if (writeReviewBtn) {
            writeReviewBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                modal.style.display = 'block';
            });
        }
        
        if (closeModal) {
            closeModal.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
        
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        ratingStars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                ratingValue.value = rating;
                
                ratingStars.forEach((s, index) => {
                    if (index < rating) {
                        s.classList.remove('far');
                        s.classList.add('fas');
                    } else {
                        s.classList.remove('fas');
                        s.classList.add('far');
                    }
                });
            });
            
            star.addEventListener('mouseenter', function() {
                const rating = parseInt(this.getAttribute('data-rating'));
                ratingStars.forEach((s, index) => {
                    s.style.color = index < rating ? '#ffc107' : '#ddd';
                });
            });
        });
        
        const ratingSelect = document.querySelector('.rating-select');
        if (ratingSelect) {
            ratingSelect.addEventListener('mouseleave', function() {
                const currentRating = parseInt(ratingValue.value) || 0;
                ratingStars.forEach((s, index) => {
                    if (index < currentRating) {
                        s.classList.remove('far');
                        s.classList.add('fas');
                        s.style.color = '#ffc107';
                    } else {
                        s.classList.remove('fas');
                        s.classList.add('far');
                        s.style.color = '#ddd';
                    }
                });
            });
        }
        
        if (reviewComment) {
            reviewComment.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });
            charCount.textContent = reviewComment.value.length;
        }
        
        if (reviewForm) {
            reviewForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const rating = parseInt(ratingValue.value);
                const comment = reviewComment.value.trim();
                
                if (!rating || rating < 1 || rating > 5) {
                    showAlert('Please select a rating', 'error');
                    return false;
                }
                
                if (!comment) {
                    showAlert('Please write a review', 'error');
                    return false;
                }
                
                if (comment.length > 200) {
                    showAlert('Review must be 200 characters or less', 'error');
                    return false;
                }
                
                submitText.style.display = 'none';
                submitLoading.style.display = 'inline-block';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/api/reviews', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            rating: rating,
                            comment: comment,
                            targetType: 'ServiceProvider',
                            targetId: serviceId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert('Review submitted successfully!', 'success');
                        
                        setTimeout(() => {
                            modal.style.display = 'none';
                        }, 1000);
                        
                        await loadReviews();
                        updateRatingDisplay(data.avgRating, data.reviewCount);
                        
                        reviewForm.reset();
                        ratingValue.value = '';
                        ratingStars.forEach(s => {
                            s.classList.remove('fas');
                            s.classList.add('far');
                        });
                        charCount.textContent = '0';
                    } else {
                        showAlert(data.message || 'Failed to submit review', 'error');
                    }
                } catch (error) {
                    console.error('Error submitting review:', error);
                    showAlert('An error occurred. Please try again.', 'error');
                } finally {
                    submitText.style.display = 'inline';
                    submitLoading.style.display = 'none';
                    submitBtn.disabled = false;
                }
                
                return false;
            });
        }
        
        async function loadReviews() {
            try {
                const response = await fetch(`/services/api/reviews/${serviceId}`);
                const data = await response.json();
                
                if (data.success) {
                    const reviewsContainer = document.getElementById('reviews-container');
                    
                    if (data.reviews.length === 0) {
                        reviewsContainer.innerHTML = '<p>No reviews yet. Be the first to review this service!</p>';
                    } else {
                        reviewsContainer.innerHTML = data.reviews.map(review => `
                            <div class="review-card">
                                <div class="review-header">
                                    <div class="review-author">${review.user ? review.user.fullName : 'Anonymous'}</div>
                                    <div class="star-rating">
                                        ${generateStars(review.rating)}
                                    </div>
                                </div>
                                <p>${review.comment}</p>
                                <small>${new Date(review.createdAt).toLocaleDateString()}</small>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
            }
        }
        
        function generateStars(rating) {
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                starsHtml += i <= rating ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
            }
            return starsHtml;
        }
        
        function updateRatingDisplay(avgRating, reviewCount) {
            const ratingElement = document.getElementById('service-rating');
            const countElement = document.getElementById('review-count');
            
            if (ratingElement) {
                ratingElement.textContent = parseFloat(avgRating).toFixed(1);
            }
            
            if (countElement) {
                countElement.textContent = reviewCount;
            }
        }
        
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = '';
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            alertContainer.appendChild(alert);
            alertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }
    });
    </script>
</body>
</html>
