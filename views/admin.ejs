<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PetVerse Admin Panel</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header" id="header">
        <nav id="navbar" class="navbar">
            <div class="nav-content">
                <div class="logo"><a href="/"><i class="fa fa-paw"></i> PetVerse</a></div>
                <div class="nav-icons">
                    <button onclick="window.location.href='/'" class="icon-btn" title="Go to Homepage"><i class="fa fa-home"></i></button>
                    <button onclick="window.location.href='/cart'" class="icon-btn"><i class="fa fa-shopping-cart"></i></button>
                    <button onclick="window.location.href='/logout'"class="icon-btn" title="Logout"><i class="fa fa-sign-out"></i></button>
                </div>
                <div class="search">
                    <input class="search-bar" type="text" placeholder=" Search pets, products or services">
                    <button class="search-btn"><i class="fa fa-search"></i></button>
                </div>
                <button class="hamburger" id="hamburger">
                    <i class="fa fa-bars"></i>
                </button>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href="/about">About</a></li>
                    <li><a href="/pets">Pets</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle">Products <i class="fa fa-angle-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="/products/petfood">Pet Food</a></li>
                            <li><a href="/products/toys">Toys</a></li>
                            <li><a href="/products/accessories">Accessories</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle">Services <i class="fa fa-angle-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="/services">Services</a></li>
                            <li><a href="/mate">PetMate</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <div class="main-container">
        <div class="admin-sidebar">
            <h2>Dashboard</h2>
            <ul class="admin-menu">
                <li class="active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard Overview</li>
                <li data-tab="pending"><i class="fas fa-clock"></i> Pending Applications</li>
                <li data-tab="approved"><i class="fas fa-check-circle"></i> Approved</li>
                <li data-tab="rejected"><i class="fas fa-times-circle"></i> Rejected</li>
            
            <h2>User Management</h2>
            <ul class="admin-menu">
                <li data-tab="all-users"><i class="fas fa-users"></i> All Users</li>
            </ul>
            
            <h2>Content Management</h2>
            <ul class="admin-menu">
                <li data-tab="products"><i class="fas fa-box"></i> Products</li>
                <li data-tab="services"><i class="fas fa-hands-helping"></i> Services</li>
                <li data-tab="pets"><i class="fas fa-paw"></i> Pets</li>
                <li data-tab="orders"><i class="fas fa-shopping-cart"></i> Orders</li>
            </ul>
            
            <h2>Filters</h2>
            <div class="filter-section">
                <h3>Application Type</h3>
                <div class="filter-options">
                    <div class="filter-option">
                        <input type="checkbox" class="filter-checkbox" name="type" value="pet" id="pet" checked>
                        <label for="pet">Pets</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" class="filter-checkbox" name="type" value="product" id="product" checked>
                        <label for="product">Products</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" class="filter-checkbox" name="type" value="service" id="service" checked>
                        <label for="service">Services</label>
                    </div>
                </div>
            </div>
            
            <div class="filter-section">
                <h3>Date Range</h3>
                <div class="date-filter">
                    <input type="date" id="start-date" placeholder="Start Date">
                    <input type="date" id="end-date" placeholder="End Date">
                    <button id="apply-date" class="filter-btn">Apply</button>
                </div>
            </div>
            
            <button class="clear-filters" id="clear-filters">Clear All Filters</button>
        </div>

        <!-- Admin Content -->
        <div class="admin-content">
            <h1 class="page-title">Admin Dashboard</h1>
            
            <!-- Success Message Container -->
            <div id="success-message-container"></div>
            
            <!-- Dashboard Cards Grid -->
            <div class="dashboard-cards-grid">
                <div class="dashboard-card green-card">
                    <div class="card-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="card-content">
                        <h3>Approved</h3>
                        <p class="card-value" id="approved-count">0</p>
                    </div>
                </div>
                
                <div class="dashboard-card orange-card">
                        <div class="card-icon">
                            <i class="fas fa-list"></i>
                        </div>
                        <div class="card-content">
                            <h3>Total Pending</h3>
                            <p class="card-value" id="total-pending-count">22</p>
                    </div>
                        </div>
                    
                    <div class="dashboard-card purple-card">
                        <div class="card-icon">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="card-content">
                            <h3>Seller</h3>
                            <p class="card-value" id="seller-count">5</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card light-green-card">
                        <div class="card-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="card-content">
                            <h3>Upcoming Renewals</h3>
                            <p class="card-value" id="upcoming-renewals">16</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card dark-teal-card">
                        <div class="card-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="card-content">
                            <h3>Active Members</h3>
                            <p class="card-value" id="active-members">1</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card pink-card">
                        <div class="card-icon">
                            <i class="fas fa-user-times"></i>
                        </div>
                        <div class="card-content">
                            <h3>Inactive Members</h3>
                            <p class="card-value" id="inactive-members">0</p>
                        </div>
                </div>
            </div>
            
            <!-- Application Content Tabs -->
            <div class="tab-content">
                <!-- Dashboard Overview Tab (default active) -->
                <div class="tab-pane active" id="dashboard-tab">
                    <h2 class="tab-title">Dashboard Overview</h2>
                    
                    <div class="admin-welcome">
                        <h3>Welcome, <%= admin ? admin.fullName : 'Admin' %>!</h3>
                        <p>Here's an overview of your PetVerse platform.</p>
                    </div>
                    
                    <div class="dashboard-analytics">
                        <div class="analytics-row">
                            <div class="analytics-card">
                                <h3>User Growth</h3>
                                <div class="chart-container">
                                    <canvas id="userGrowthChart"></canvas>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <h3>User Distribution</h3>
                                <div class="chart-container">
                                    <canvas id="userDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="analytics-row">
                            <div class="analytics-card">
                                <h3>Product Categories</h3>
                                <div class="chart-container">
                                    <canvas id="productCategoriesChart"></canvas>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <h3>Monthly Revenue</h3>
                                <div class="chart-container">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-summary">
                        <h3>Platform Summary</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <i class="fas fa-users"></i>
                                <div class="summary-info">
                                    <p class="summary-label">Total Users</p>
                                    <p class="summary-value"><%= platformSummary.totalUsers %></p>
                                </div>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-store"></i>
                                <div class="summary-info">
                                    <p class="summary-label">Active Sellers</p>
                                    <p class="summary-value"><%= platformSummary.activeSellers %></p>
                                </div>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-concierge-bell"></i>
                                <div class="summary-info">
                                    <p class="summary-label">Service Providers</p>
                                    <p class="summary-value"><%= platformSummary.serviceProviders %></p>
                                </div>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-box"></i>
                                <div class="summary-info">
                                    <p class="summary-label">Total Products</p>
                                    <p class="summary-value"><%= platformSummary.totalProducts %></p>
                                </div>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-paw"></i>
                                <div class="summary-info">
                                    <p class="summary-label">Pets Listed</p>
                                    <p class="summary-value"><%= platformSummary.petsListed %></p>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <!-- Recent Orders section removed (now solely managed in Orders tab) -->
                
                <!-- Pending Applications Tab -->
                <div class="tab-pane" id="pending-tab">
                    <h2 class="tab-title">Pending Applications</h2>
                    <div class="applications-list">
                        <% if (pendingApplications.length === 0) { %>
                            <p>No pending applications</p>
                        <% } %>
                        <% pendingApplications.forEach(application => { %>
                            <div class="application-card" data-id="<%= application.id %>" data-type="<%= application.type %>">
                                <div class="application-header">
                                    <span class="application-type <%= application.type %>"><%= application.type %></span>
                                    <span class="application-date"><%= application.date %></span>
                                </div>
                                <div class="application-body">
                                    <div class="application-info">
                                        <h3 class="application-name"><%= application.name %></h3>
                                        <p class="application-provider">
                                            <i class="fa fa-user"></i> <%= application.provider.name %>
                                        </p>
                                        <p class="application-location">
                                            <i class="fa fa-map-marker-alt"></i> <%= application.location %>
                                        </p>
                                        <p class="application-description"><%= application.description %></p>
                                        
                                        <% if (application.type === 'service') { %>
                                            <div class="application-details">
                                                <p class="application-category">
                                                    <strong>Category:</strong> <%= application.category %>
                                                </p>
                                                <p class="application-price">
                                                    <strong>Price:</strong> ₹<%= application.price %>
                                                </p>
                                            </div>
                                        <% } else if (application.type === 'product') { %>
                                            <div class="application-details">
                                                <p class="application-category">
                                                    <strong>Category:</strong> <%= application.category %>
                                                </p>
                                                <p class="application-price">
                                                    <strong>Price:</strong> ₹<%= application.price %>
                                                </p>
                                                <p class="application-stock">
                                                    <strong>Stock:</strong> <%= application.stock %> units
                                                </p>
                                            </div>
                                        <% } else { %>
                                            <div class="application-details">
                                                <p class="application-breed">
                                                    <strong>Breed:</strong> <%= application.breed || 'N/A' %>
                                                </p>
                                                <p class="application-age">
                                                    <strong>Age:</strong> <%= application.age || 'N/A' %>
                                                </p>
                                                <p class="application-price">
                                                    <strong>Price:</strong> ₹<%= application.price %>
                                                </p>
                                            </div>
                                        <% } %>
                                        
                                        <div class="application-actions">
                                            <button class="approve-btn" onclick="approveApplication('<%= application.id %>')">
                                                <i class="fas fa-check"></i> Approve
                                            </button>
                                            <button class="reject-btn" onclick="rejectApplication('<%= application.id %>')">
                                                <i class="fas fa-times"></i> Reject
                                            </button>
                                            <button class="view-details-btn" onclick="viewApplicationDetails('<%= application.id %>')">
                                                <i class="fas fa-eye"></i> View Details
                                            </button>
                                            <button class="view-credentials-btn" onclick="viewCredentials('<%= application.provider.id %>')">
                                                <i class="fas fa-id-card"></i> View Credentials
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
                
                <!-- Approved Applications Tab -->
                <div class="tab-pane" id="approved-tab">
                    <h2 class="tab-title">Approved Applications</h2>
                    <div class="applications-list">
                        <% approvedApplications.forEach(application => { %>
                            <div class="application-card" data-id="<%= application.id %>" data-type="<%= application.type %>">
                                <div class="application-header">
                                    <span class="application-type <%= application.type %>"><%= application.type %></span>
                                    <span class="application-date"><%= application.date %></span>
                                    <span class="approval-date">Approved on: <%= application.approvalDate %></span>
                                </div>
                                <div class="application-body">
                                    <div class="application-info">
                                        <h3 class="application-name"><%= application.name %></h3>
                                        <p class="application-provider">
                                            <i class="fa fa-user"></i> <%= application.provider.name %>
                                        </p>
                                        <p class="application-description"><%= application.description %></p>
                                        
                                        <div class="application-actions">
                                            <button class="revoke-btn" onclick="revokeApproval('<%= application.id %>')">
                                                <i class="fas fa-undo"></i> Revoke Approval
                                            </button>
                                            <button class="view-details-btn" onclick="viewApplicationDetails('<%= application.id %>')">
                                                <i class="fas fa-eye"></i> View Details
                                            </button>
                                            <button class="view-credentials-btn" onclick="viewCredentials('<%= application.provider.id %>')">
                                                <i class="fas fa-id-card"></i> View Credentials
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
                
                <!-- Rejected Applications Tab -->
                <div class="tab-pane" id="rejected-tab">
                    <h2 class="tab-title">Rejected Applications</h2>
                    <div class="applications-list">
                        <% if (rejectedApplications.length === 0) { %>
                            <p>No pending applications</p>
                        <% } %>
                        <% rejectedApplications.forEach(application => { %>
                            <div class="application-card" data-id="<%= application.id %>" data-type="<%= application.type %>">
                                <div class="application-header">
                                    <span class="application-type <%= application.type %>"><%= application.type %></span>
                                    <span class="application-date"><%= application.date %></span>
                                    <span class="rejection-date">Rejected on: <%= application.rejectionDate %></span>
                                </div>
                                <div class="application-body">
                                    <div class="application-info">
                                        <h3 class="application-name"><%= application.name %></h3>
                                        <p class="application-provider">
                                            <i class="fa fa-user"></i> <%= application.provider.name %>
                                        </p>
                                        <p class="rejection-reason">Reason: <%= application.rejectionReason %></p>
                                        
                                        <div class="application-actions">
                                            <button class="reconsider-btn" onclick="reconsiderApplication('<%= application.id %>')">
                                                <i class="fas fa-redo"></i> Reconsider
                                            </button>
                                            <button class="view-details-btn" onclick="viewApplicationDetails('<%= application.id %>')">
                                                <i class="fas fa-eye"></i> View Details
                                            </button>
                                            <button class="view-credentials-btn" onclick="viewCredentials('<%= application.provider.id %>')">
                                                <i class="fas fa-id-card"></i> View Credentials
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
                
                <!-- All Users Tab -->
                <div class="tab-pane" id="all-users-tab">
                    <h2 class="tab-title">All Users</h2>
                    <div class="search-filter-bar">
                        <div class="search-input">
                            <input type="text" id="user-search" placeholder="Search users...">
                            <button id="search-user-btn"><i class="fas fa-search"></i></button>
                        </div>
                        <div class="filter-dropdown">
                            <select id="user-role-filter">
                                <option value="all">All Roles</option>
                                <option value="owner">Owners</option>
                                <option value="seller">Sellers</option>
                                <option value="service_provider">Service Providers</option>
                                <option value="admin">Admins</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="users-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Joined Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <% allUsers.forEach(user => { %>
                                    <tr data-id="<%= user._id %>">
                                        <td><%= user.fullName %></td>
                                        <td>@<%= user.username %></td>
                                        <td><%= user.email %></td>
                                        <td><span class="role-badge <%= user.role %>"><%= user.role %></span></td>
                                        <td>
                                            <% if (['seller', 'service_provider'].includes(user.role)) { %>
                                                <span class="status-badge <%= user.isApproved ? 'approved' : 'pending' %>">
                                                    <%= user.isApproved ? 'Approved' : 'Pending' %>
                                                </span>
                                            <% } else { %>
                                                <span class="status-badge approved">Active</span>
                                            <% } %>
                                        </td>
                                        <td><%= new Date(user.createdAt).toLocaleDateString() %></td>
                                        <td class="action-buttons">
                                            <button onclick="viewUserDetails('<%= user._id %>')" class="view-btn" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button onclick="editUser('<%= user._id %>')" class="edit-btn" title="Edit User">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <% if (['seller', 'service_provider'].includes(user.role) && !user.isApproved) { %>
                                                <button onclick="approveUser('<%= user._id %>')" class="approve-btn" title="Approve User">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            <% } %>
                                            <button onclick="deleteUser('<%= user._id %>')" class="delete-btn" title="Delete User">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pagination">
                        <button id="prev-page"><i class="fas fa-chevron-left"></i></button>
                        <span id="page-info">Page 1 of 5</span>
                        <button id="next-page"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <!-- Products Tab -->
                <div class="tab-pane" id="products-tab">
                    <h2 class="tab-title">Product Management</h2>
                    <div class="search-filter-bar">
                        <div class="search-input">
                            <input type="text" id="product-search" placeholder="Search products...">
                            <button id="search-product-btn"><i class="fas fa-search"></i></button>
                        </div>
                        <div class="filter-dropdown">
                            <select id="product-category-filter">
                                <option value="all">All Categories</option>
                                <option value="food">Pet Food</option>
                                <option value="toys">Toys</option>
                                <option value="accessories">Accessories</option>
                                <option value="health">Health & Wellness</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="products-grid">
                        <% products.forEach(product => { %>
                            <div class="product-card" data-id="<%= product._id %>" data-name="<%= product.name %>" data-category="<%= product.category || '' %>" data-seller="<%= (product.seller && product.seller.businessName) || '' %>">
                                <div class="product-image">
                                    <% 
                                        let imgSrc = product.image;
                                        if (!imgSrc && product.images && product.images.length > 0) {
                                            const img = product.images[0];
                                            if (img.url) {
                                                imgSrc = img.url;
                                            } else if (img.data && img.contentType) {
                                                let base64 = '';
                                                if (typeof img.data === 'string') {
                                                    base64 = img.data;
                                                } else if (img.data && img.data.buffer) {
                                                    base64 = Buffer.from(img.data.buffer).toString('base64');
                                                }
                                                imgSrc = `data:${img.contentType};base64,${base64}`;
                                            }
                                        }
                                    %>
                                    <img src="<%= imgSrc || '/images/products/product1.jpg' %>" alt="<%= product.name %>">
                                </div>
                                <div class="product-info">
                                    <h3><%= product.name %></h3>
                                    <p class="product-seller">by <%= product.seller.businessName %></p>
                                    <p class="product-price">₹<%= product.price %></p>
                                    <p class="product-stock"><%= product.stock %> in stock</p>
                                    <div class="product-status <%= product.isApproved ? 'approved' : 'pending' %>">
                                        <%= product.isApproved ? 'Active' : 'Pending Approval' %>
                                    </div>
                                    <div class="product-actions">
                                        <button onclick="viewProduct('<%= product._id %>')" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <% if (!product.isApproved) { %>
                                            <button onclick="approveProduct('<%= product._id %>')" title="Approve Product">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        <% } else { %>
                                            <button onclick="deactivateProduct('<%= product._id %>')" title="Deactivate Product">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        <% } %>
                                        <button onclick="deleteProduct('<%= product._id %>')" title="Delete Product">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                    
                    <div class="pagination">
                        <button id="products-prev-page" class="page-btn" title="Previous"><i class="fas fa-chevron-left"></i></button>
                        <span id="products-page-info" class="page-info">Page 1 of 3</span>
                        <button id="products-next-page" class="page-btn" title="Next"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <!-- Content Management - Pets Tab -->
                <div class="tab-pane" id="pets-tab">
                    <h2 class="tab-title">Pet Management</h2>
                    <div class="search-filter-bar">
                        <div class="search-input">
                            <input type="text" id="pet-search" placeholder="Search pets...">
                            <button id="search-pet-btn"><i class="fas fa-search"></i></button>
                        </div>
                        <div class="filter-dropdown">
                            <select id="pet-category-filter">
                                <option value="all">All Categories</option>
                                <option value="Dog">Dogs</option>
                                <option value="Cat">Cats</option>
                                <option value="Bird">Birds</option>
                                <option value="Fish">Fish</option>
                                <option value="Other">Other Pets</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="pets-grid">
                        <% if (pets && pets.length > 0) { %>
                            <% pets.forEach(pet => { %>
                                <div class="pet-card" data-id="<%= pet._id %>" data-name="<%= pet.name.toLowerCase() %>" data-category="<%= pet.category %>" data-breed="<%= pet.breed.toLowerCase() %>">
                                    <div class="pet-image">
                                        <% if (pet.images && pet.images.length > 0 && pet.images[0].data) { %>
                                            <img src="data:<%= pet.images[0].contentType %>;base64,<%= pet.images[0].data.toString('base64') %>" alt="<%= pet.name %>">
                                        <% } else { %>
                                            <div class="no-image">No Image</div>
                                        <% } %>
                                    </div>
                                    <div class="pet-info">
                                        <h3><%= pet.name %></h3>
                                        <p class="pet-breed"><%= pet.breed %></p>
                                        <p class="pet-category"><%= pet.category %></p>
                                        <p class="pet-age"><%= pet.age %></p>
                                        <p class="pet-price">₹<%= pet.price %></p>
                                        <div class="pet-status <%= pet.available ? 'available' : 'unavailable' %>">
                                            <%= pet.available ? 'Available' : 'Unavailable' %>
                                        </div>
                                        <div class="pet-actions">
                                            <button onclick="viewPet('<%= pet._id %>')" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button onclick="<%= pet.available ? 'markPetUnavailable' : 'markPetAvailable' %>('<%= pet._id %>')" title="<%= pet.available ? 'Mark Unavailable' : 'Mark Available' %>">
                                                <i class="fas fa-<%= pet.available ? 'ban' : 'check' %>"></i>
                                            </button>
                                            <button onclick="deletePet('<%= pet._id %>')" title="Delete Pet">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="empty-state">
                                <i class="fas fa-paw"></i>
                                <p>No pets listed yet.</p>
                            </div>
                        <% } %>
                    </div>
                    
                    <div class="pagination">
                        <button id="pets-prev-page"><i class="fas fa-chevron-left"></i></button>
                        <span id="pets-page-info">Page 1 of 1</span>
                        <button id="pets-next-page"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <!-- Content Management - Services Tab -->
                <div class="tab-pane" id="services-tab">
                    <h2 class="tab-title">Service Management</h2>
                    <div class="search-filter-bar">
                        <div class="search-input">
                            <input type="text" id="service-search" placeholder="Search services...">
                            <button id="search-service-btn"><i class="fas fa-search"></i></button>
                        </div>
                        <div class="filter-dropdown">
                            <select id="service-type-filter">
                                <option value="all">All Types</option>
                                <option value="veterinarian">Veterinarian</option>
                                <option value="groomer">Groomer</option>
                                <option value="pet sitter">Pet Sitter</option>
                                <option value="trainer">Trainer</option>
                                <option value="breeder">Breeder</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="services-grid">
                        <% if (services && services.length > 0) { %>
                            <% services.forEach(service => { %>
                                <div class="service-card" data-id="<%= service._id %>" data-name="<%= service.name.toLowerCase() %>" data-type="<%= (service.provider && service.provider.serviceType || '').toLowerCase() %>" data-provider="<%= (service.provider && service.provider.fullName || '').toLowerCase() %>">
                                    <div class="service-info">
                                        <h3><%= service.name %></h3>
                                        <p class="service-provider">by <%= service.provider && service.provider.fullName || 'Unknown Provider' %></p>
                                        <p class="service-type"><%= service.provider && service.provider.serviceType || 'General Service' %></p>
                                        <p class="service-location"><i class="fas fa-map-marker-alt"></i> <%= service.provider && service.provider.serviceAddress || 'Location not specified' %></p>
                                        <p class="service-description"><%= service.description || 'No description available' %></p>
                                        <div class="service-status <%= service.isApproved ? 'approved' : 'pending' %>">
                                            <%= service.isApproved ? 'Approved' : 'Pending Approval' %>
                                        </div>
                                        <div class="service-actions">
                                            <button onclick="viewService('<%= service._id %>')" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <% if (!service.isApproved) { %>
                                                <button onclick="approveService('<%= service._id %>')" title="Approve Service">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            <% } else { %>
                                                <button onclick="deactivateService('<%= service._id %>')" title="Deactivate Service">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                            <% } %>
                                            <button onclick="deleteService('<%= service._id %>')" title="Delete Service">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="empty-state">
                                <i class="fas fa-concierge-bell"></i>
                                <p>No services listed yet.</p>
                            </div>
                        <% } %>
                    </div>
                    
                    <div class="pagination">
                        <button id="services-prev-page"><i class="fas fa-chevron-left"></i></button>
                        <span id="services-page-info">Page 1 of 1</span>
                        <button id="services-next-page"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- Orders Management Tab -->
                <div class="tab-pane" id="orders-tab">
                    <h2 class="tab-title">Order Management</h2>
                    <% if (orders && orders.length > 0) { %>
                        <div class="orders-table-container">
                            <table class="orders-table">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Seller</th>
                                        <th>Items</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Placed</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% orders.forEach(order => { %>
                                        <tr data-id="<%= order._id %>">
                                            <td>#<%= order.orderNumber || order._id %></td>
                                            <td>
                                                <div class="customer-info">
                                                    <strong><%= order.customer && order.customer.fullName || 'Unknown' %></strong>
                                                    <br><small><%= order.customer && order.customer.email || 'No email' %></small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="seller-info">
                                                    <strong><%= order.seller && (order.seller.businessName || order.seller.fullName) || 'Unknown' %></strong>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="order-items">
                                                    <% order.items.forEach(item => { %>
                                                        <div class="order-item">
                                                            <span class="item-name"><%= item.product && item.product.name || 'Product' %></span>
                                                            <span class="item-quantity">×<%= item.quantity %></span>
                                                        </div>
                                                    <% }) %>
                                                </div>
                                            </td>
                                            <td>₹<%= order.totalAmount.toLocaleString() %></td>
                                            <td>
                                                <select class="order-status-select">
                                                    <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Pending</option>
                                                    <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>Processing</option>
                                                    <option value="completed" <%= order.status === 'completed' ? 'selected' : '' %>>Completed</option>
                                                    <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                                                </select>
                                            </td>
                                            <td><%= new Date(order.createdAt).toLocaleDateString() %></td>
                                            <td>
                                                <button class="update-order-status">Update</button>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <p>No orders found.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Application Detail Modal -->
    <div class="modal" id="application-detail-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 class="modal-title">Application Details</h2>
            <div class="modal-body" id="application-detail-content">
                <!-- Application details will be loaded here via JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="close-btn">Close</button>
                <div class="modal-actions" id="modal-action-buttons">
                    <!-- Action buttons will be loaded here via JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rejection Reason Modal -->
    <div class="modal" id="rejection-reason-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 class="modal-title">Rejection Reason</h2>
            <div class="modal-body">
                <p>Please provide a reason for rejection:</p>
                <textarea id="rejection-reason" rows="4" placeholder="Enter rejection reason..."></textarea>
                <input type="hidden" id="rejection-application-id" value="">
            </div>
            <div class="modal-footer">
                <button class="cancel-btn">Cancel</button>
                <button class="confirm-reject-btn" id="confirm-reject-btn">
                    <i class="fas fa-times"></i> Confirm Rejection
                </button>
            </div>
        </div>
    </div>
    
    <!-- Credentials Modal -->
    <div class="modal" id="credentials-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 class="modal-title">Provider Credentials</h2>
            <div class="modal-body" id="credentials-content">
                <div class="credentials-info">
                    <div class="credential-section">
                        <h3>Personal Information</h3>
                        <p><strong>Full Name:</strong> <span id="credential-name">...</span></p>
                        <p><strong>Email:</strong> <span id="credential-email">...</span></p>
                        <p><strong>Phone:</strong> <span id="credential-phone">...</span></p>
                        <p><strong>Address:</strong> <span id="credential-address">...</span></p>
                    </div>
                    
                    <div class="credential-section">
                        <h3>Business Details</h3>
                        <p><strong>Business Name:</strong> <span id="credential-business-name">...</span></p>
                        <p><strong>Registration Number:</strong> <span id="credential-reg-number">...</span></p>
                        <p><strong>Years in Business:</strong> <span id="credential-years">...</span></p>
                    </div>
                    
                    <div class="credential-section">
                        <h3>Documents</h3>
                        <div class="document-links">
                            <a href="#" class="document-link">ID Proof</a>
                            <a href="#" class="document-link">Business License</a>
                            <a href="#" class="document-link">Tax Certificate</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="close-btn">Close</button>
            </div>
        </div>
    </div>
    <%- include('partials/footer') %>
    <script src="/js/admin.js"></script>
    <script>
      // Get all dropdown toggles and menus
        const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
        const dropdownMenus = document.querySelectorAll('.dropdown-menu');

      // Add click event to each dropdown toggle
        dropdownToggles.forEach((toggle, index) => {
        toggle.addEventListener('click', function(event) {
            event.stopPropagation(); // Prevent this click from triggering the document click handler
            
            // Close all other dropdown menus first
            dropdownMenus.forEach((menu, menuIndex) => {
                if (menuIndex !== index) {
                menu.classList.remove('show');
                }
            });
            
            // Toggle the current dropdown menu
            const currentDropdownMenu = this.nextElementSibling;
            currentDropdownMenu.classList.toggle('show');
        });
        });

      // Close all dropdowns when clicking anywhere else on the page
        document.addEventListener('click', function(event) {  
        // Check if click is outside of any dropdown
        if (!event.target.closest('.dropdown')) {
          // Close all dropdown menus
            dropdownMenus.forEach(menu => {
            if (menu.classList.contains('show')) {
                menu.classList.remove('show');
            }
            });
        }
        });
        
      // Dashboard tab functionality
        document.addEventListener('DOMContentLoaded', function() {
        // Tab switching
        const tabLinks = document.querySelectorAll('.admin-menu li');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        tabLinks.forEach(link => {
            link.addEventListener('click', function() {
            // Remove active class from all links
            tabLinks.forEach(l => l.classList.remove('active'));
            
            // Add active class to clicked link
            this.classList.add('active');
            
            // Hide all tab panes
            tabPanes.forEach(pane => pane.classList.remove('active'));
            
            // Show the selected tab pane
            const tabId = this.getAttribute('data-tab') + '-tab';
            document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Initialize charts
        initializeCharts();

        // User approval functions
        window.approveUser = function(userId) {
          // Make an AJAX call to approve the user
            fetch(`/admin/approve-user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
            })
            .then(response => response.json())
            .then(data => {
            if (data.success) {
                showSuccessMessage('User approved successfully!');
                
              // Remove the user card from the pending users tab
                const userCard = document.querySelector(`.user-card[data-id="${userId}"]`);
                if (userCard) {
                userCard.style.display = 'none';
                }
                
              // Update the counts in the dashboard
                const pendingCount = document.getElementById('pending-count');
                const approvedCount = document.getElementById('approved-count');
                if (pendingCount) {
                    pendingCount.textContent = parseInt(pendingCount.textContent) - 1;
                }
                if (approvedCount) {
                approvedCount.textContent = parseInt(approvedCount.textContent) + 1;
                }
            } else {
                showErrorMessage(data.error || 'Failed to approve user');
            }
            })
            .catch(error => {
            console.error('Error approving user:', error);
            showErrorMessage('Failed to approve user. Please try again.');
            });
        };
        
        window.rejectUser = function(userId) {
          // Get rejection reason
            const reason = prompt('Please enter a reason for rejection:');
            if (reason === null) {
            // User canceled the prompt
            return;
            }
            
          // Make an AJAX call to reject the user
            fetch(`/admin/reject-user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rejectionReason: reason })
            })
            .then(response => response.json())
            .then(data => {
            if (data.success) {
                showSuccessMessage('User rejected successfully!');
                
              // Remove the user card from the pending users tab
                const userCard = document.querySelector(`.user-card[data-id="${userId}"]`);
                if (userCard) {
                userCard.style.display = 'none';
                }
                
              // Update the counts in the dashboard
                const pendingCount = document.getElementById('pending-count');
                const rejectedCount = document.getElementById('rejected-count');
                if (pendingCount) {
                pendingCount.textContent = parseInt(pendingCount.textContent) - 1;
                }
                if (rejectedCount) {
                rejectedCount.textContent = parseInt(rejectedCount.textContent) + 1;
                }
            } else {
                showErrorMessage(data.error || 'Failed to reject user');
            }
            })
            .catch(error => {
            console.error('Error rejecting user:', error);
            showErrorMessage('Failed to reject user. Please try again.');
            });
        };
        
        window.viewUserDocument = function(userId, role) {
          // Open a new window/tab to view the document
            window.open(`/admin/user-document/${userId}`, '_blank');
        };
      });
      
      function showSuccessMessage(message) {
        const container = document.getElementById('success-message-container');
        const messageEl = document.createElement('div');
        messageEl.className = 'success-message';
        messageEl.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        container.appendChild(messageEl);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
          messageEl.classList.add('fade-out');
          setTimeout(() => {
            container.removeChild(messageEl);
          }, 500);
        }, 3000);
      }
      
      function showErrorMessage(message) {
        const container = document.getElementById('success-message-container');
        const messageEl = document.createElement('div');
        messageEl.className = 'error-message';
        messageEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        container.appendChild(messageEl);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
          messageEl.classList.add('fade-out');
          setTimeout(() => {
            container.removeChild(messageEl);
          }, 500);
        }, 3000);
      }
      
      function initializeCharts() {
        // Get data from JSON script tags
        const userGrowthData = JSON.parse(document.getElementById('chart-user-growth').textContent);
        const userDistributionData = JSON.parse(document.getElementById('chart-user-distribution').textContent);
        const productCategoriesData = JSON.parse(document.getElementById('chart-product-categories').textContent);
        const revenueData = JSON.parse(document.getElementById('chart-revenue').textContent);
        
        // User Growth Chart (Line chart)
        const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
        const userGrowthChart = new Chart(userGrowthCtx, {
            type: 'line',
            data: {
                labels: userGrowthData.labels,
                datasets: [{
                label: 'New Users',
                data: userGrowthData.data,
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.3,
                fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                legend: {
                    display: false
                }
                },
                scales: {
                y: {
                    beginAtZero: true,
                    title: {
                    display: true,
                    text: 'Number of Users'
                    }
                },
                x: {
                    title: {
                    display: true,
                    text: 'Month'
                    }
                }
                }
            }
        });
        
        // User Distribution Chart (Pie chart)
        const userDistributionCtx = document.getElementById('userDistributionChart').getContext('2d');
        const userDistributionChart = new Chart(userDistributionCtx, {
            type: 'pie',
            data: {
                labels: userDistributionData.labels,
                datasets: [{
                data: userDistributionData.data,
                backgroundColor: [
                    '#2196F3',
                    '#FFC107',
                    '#9C27B0',
                    '#F44336'
                ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                legend: {
                    position: 'right'
                }
                }
            }
        });
        
        // Product Categories Chart (Bar chart)
        const productCategoriesCtx = document.getElementById('productCategoriesChart').getContext('2d');
        const productCategoriesChart = new Chart(productCategoriesCtx, {
            type: 'bar',
            data: {
                labels: productCategoriesData.labels,
                datasets: [{
                label: 'Number of Products',
                data: productCategoriesData.data,
                backgroundColor: '#3F51B5'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                legend: {
                    display: false
                }
                },
                scales: {
                y: {
                    beginAtZero: true
                }
                }
            }
        });
        
        // Revenue Chart (Line chart)
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        const revenueChart = new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: revenueData.labels,
                datasets: [{
                label: 'Monthly Revenue',
                data: revenueData.data,
                borderColor: '#FF5722',
                backgroundColor: 'rgba(255, 87, 34, 0.1)',
                tension: 0.3,
                fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                legend: {
                    display: false
                }
                },
                scales: {
                y: {
                    beginAtZero: true,
                    title: {
                    display: true,
                    text: 'Revenue (₹)'
                    }
                },
                x: {
                    title: {
                    display: true,
                    text: 'Month'
                    }
                }
                }
            }
            });
        }
    </script>
    <!-- Script data for charts -->
    <script type="application/json" id="chart-user-growth">
        <%- JSON.stringify(userGrowthData || {}) %>
    </script>
    
    <script type="application/json" id="chart-user-distribution">
        <%- JSON.stringify(userDistributionData || {}) %>
    </script>
    
    <script type="application/json" id="chart-product-categories">
        <%- JSON.stringify(productCategoriesData || {}) %>
    </script>
    
    <script type="application/json" id="chart-revenue">
        <%- JSON.stringify(revenueData || {}) %>
    </script>
</body>
</html>
