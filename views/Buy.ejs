<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetVerse - <%= product.title || product.name %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/css/products.css">
    <link rel="stylesheet" href="/css/Buy.css">
    <script src="/js/cart.js"></script>
</head>

<body>
    
    <!-- Hidden element to store product data -->
    <div id="productData" data-product='<%= JSON.stringify(product) %>' style="display: none;"></div>
    
    <%- include('partials/header') %>

    <section style="font-size: 1.5rem; margin-top: 60px;display: flex;gap: 50px;">
        <div class="slider-container">
            <div id="mainImage" class="main-image" style="cursor: pointer;">
                <% if (product.images && product.images.length > 0) { %>
                    <img src="data:<%= product.images[0].contentType %>;base64,<%= product.images[0].data.toString('base64') %>" 
                         alt="<%= product.name %>" 
                         class="main-product-image"
                         data-index="0">
                <% } else { %>
                    <img src="/images/default-product.jpg" alt="<%= product.name %>" class="main-product-image">
                <% } %>
            </div>
            <div class="thumbnail-container">
                <% if (product.images && product.images.length > 0) { %>
                    <% product.images.forEach((image, index) => { %>
                        <img src="data:<%= image.contentType %>;base64,<%= image.data.toString('base64') %>" 
                             class="thumbnail" 
                             data-index="<%= index %>"
                             alt="<%= product.name %> - Image <%= index + 1 %>">
                    <% }); %>
                <% } else { %>
                    <img src="/images/default-product.jpg" class="thumbnail" alt="<%= product.name %>">
                <% } %>
            </div>
        </div>
        <div data-type="<%= product.type %>">
            <h3>
                <%= product.title || product.name %>
            </h3>
            <div class="rating-container" id="rating" onclick="scrollToRate()">
                <span class="stars" id="stars"></span>
                <span class="rating-value" id="ratingValue"></span>
                <span id="ratingCount"></span>
            </div>
            <div class="price-seller-container">
                <div class="price">
                    <span
                        style="background-color: #CC0C39;border-radius: 10px;height: auto;color: #fff;padding: 10px;width: fit-content;font-size: 1.2rem;"><i
                            class="fa fa-bolt" aria-hidden="true"></i>&nbsp;&nbsp;Lightning Deal
                    </span>
                    <span class="final-price">
                        MRP: ₹ <%= product.price %>
                        
                        <span style="font-size: small;" class="discount">
                            <% 
                            const mrp = parseFloat(product.mrp);
                            const price = parseFloat(product.price);
                            const discountPercentage = Math.round(((mrp - price) / mrp) * 100);
                            %>
                            SAVE <%= product.discount || discountPercentage %>% OFF
                            <span style="font-family: cursive;font-size: 0.4rem;"> (Incl. of all taxes)</span>
                        </span>
                    </span>
                    
                    <div class="cart-item-shipping">
                        <i class="fa fa-truck"></i>
                        <span>Free Delivery</span>
                        <div class="delivery-estimate">Estimated delivery: 2-4 days<div class="stock-status">
                                <% if (product.stock> 0) { %>
                                    <i class="fa fa-check-circle" style="color: #10b981;"> In Stock</i>
                                    <% } else { %>
                                        <i class="fa fa-times-circle" style="color: #ef4444;">Out of Stock</i>
                                        <% } %>
                            </div>
                        </div>

                    </div>
                    <span style="color: red;font-family: sans-serif;font-size: 1rem;">Note:<span
                            style=" font-size: 1rem;color: #222;"> Your order will be delivered to our store. Please
                            visit and collect it with a valid ID and order confirmation.</span></span>

                </div>

                <div class="seller-info">
                    <h4>Seller Information</h4>
                    <div id="sellerName">Seller: <span id="sellerNameText"><%= seller ? seller.businessName : 'PetWorld Store' %></span></div>
                    <div id="sellerRating">Rating: <span id="sellerRatingText"><%= seller && seller.rating ? seller.rating + ' / 5' : '4.5 / 5' %></span></div>
                    <div id="sellerReviews">Reviews: <span id="sellerReviewsText"><%= seller && seller.reviewCount ? seller.reviewCount + ' reviews' : 'No reviews yet' %></span></div>
                    <div id="sellerContact">Contact: <span id="sellerContactText"><%= seller ? seller.email + ' | ' + seller.phone : 'contact@petworld.com | +91 1234567890' %></span></div>
                    <p class="text-p">
                        This session covers important details about the event, location, and other relevant
                        information.You Can refer to Our Pages Given Below
                        <a href="#footer" class="read-more">Read More</a>
                    </p>

                </div>
            </div>

            <div class="address">
                <h4 style="font-size: 1.4rem;margin-bottom: 5px;color: #333;">Check delivery date</h4>
                <p style="color: gray; font-size: 0.9rem;" class="text-p">24 hours delivery available</p>
                <input type="text" id="pincodeInput" placeholder="Enter Pincode"
                    style="border: none; border-bottom: 1px solid black; padding: 5px; width: 200px; font-size: 1rem;">
                <button onclick="fetchAddress()"
                    style="background: none; border: none; color: orange; font-size: 1rem; cursor: pointer;">Check</button>
                <div class="action-buttons">
                    <button class="add-to-cart-btn">
                        <i class="fa fa-shopping-cart" style="font-size: 1.5rem;"></i>
                        Add to Cart
                    </button>
                    <button class="buy-now-btn" style="margin-left: 5px;">
                        <img src="/images/dash/buy.png" alt="buy" style="width: 50px;height: 50px;border: unset;" />
                        Buy Now
                    </button>
                </div>
                <p id="placeOutput" style="margin-top: 5px; font-size: 1rem; color: black;" class="text-p"></p>
            </div>
        </div>
    </section>
    <div class="similar-products-section">
        <h2 class="section-title">Similar Products</h2>
        <div class="products-slider">
            <button class="slider-nav prev" onclick="slideProducts(-1)">
                <i class="fa fa-chevron-left"></i>
            </button>
            <div class="products-container">
                <% if (similarProducts && similarProducts.length > 0) { %>
                <% similarProducts.forEach(similar=> { %>
                    <div class="container" onclick="window.location.href='/buy/<%= similar._id %>'">
                        <div class="card">
                            <div class="card-head">
                                <img src="/images/dash/<%= similar.image_url %>" alt="<%= similar.title || similar.name %>" class="card-logo">
                            </div>
                            <div class="card-body">
                                <div class="product-desc">
                                    <span class="product-title">
                                        <%= similar.title || similar.name %>
                                            <span class="badge">
                                                <%= similar.category %>
                                            </span>
                                    </span>
                                    <span class="product-rating">
                                        <% for(let i = 0; i < 5; i++) { %>
                                            <i class="fa fa-star <%= i < similar.rating ? '' : 'grey' %>"></i>
                                        <% } %>
                                    </span>
                                </div>
                                <div class="product-properties">
                                    <span class="product-size">
                                        <% if (similar.brand) { %>
                                            <h4>Brand: <b><%= similar.brand %></b></h4>
                                        <% } %>
                                        <h3 style="color: #000000;">₹ <%= similar.price %>
                                            <% if (similar.discount > 0) { %>
                                                <span style="font-size:x-small;" class="discount-text">&nbsp;<%= similar.discount %>% Off</span>
                                            <% } %>
                                        </h3>
                                    </span>
                                    <span class="product-color">
                                        <button class="product-price" data-product-id="<%= similar._id %>">
                                            Add To Cart
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <% }); %>
                <% } else { %>
                    <div class="no-similar-products">
                        <p>No similar products found.</p>
                    </div>
                <% } %>
            </div>
            <button class="slider-nav next" onclick="slideProducts(1)">
                <i class="fa fa-chevron-right"></i>
            </button>
        </div>
    </div>
    <div id="fullscreenContainer" class="fullscreen" style="display: none;">
        <span class="close-btn">&times;</span>
        <span class="prev-btn">&#10094;</span>
        <img id="fullscreenImage" src="" alt="Fullscreen Image">
        <span class="next-btn">&#10095;</span>
    </div>
    <br>

    <div class="features-container">
        <div class="feature-box">
            <img src="/images/dash/delivery.png" alt="Free Delivery" style="border: unset;">
            <p>Free Delivery </p>
        </div>
        <div class="feature-box">
            <img src="/images/dash/noreturn.jpg" alt="No Returns" style="border: unset;">
            <p>No Returns <br> & Exchange</p>
        </div>
        <div class="feature-box">
            <img src="/images/dash/cash-on-delivery.png" alt="Pay on Delivery" style="border: unset;">
            <p>Pay On Delivery</p>
        </div>
        <div class="feature-box">
            <img src="/images/dash/veterinary.png" alt="check up" style="border: unset;">
            <p>Free Check Up</p>
        </div>
    </div>

    <div class="product-details-section">
        <h2 class="section-title">Product Details</h2>
        <div class="details-content">
            <h3 class="product-title">
                <%= product.title || product.name %>
            </h3>
            <div class="key-features">
                <% if (product.brand) { %>
                    <p><strong>Brand:</strong> <%= product.brand %></p>
                <% } %>
                <% if (product.category) { %>
                    <p><strong>Category:</strong> <%= product.category %></p>
                <% } %>
                <% if (product.description) { %>
                    <p><strong>Description:</strong> <%= product.description %></p>
                <% } %>
                <% if (product.tags && product.tags.length > 0) { %>
                    <p><strong>Tags:</strong> <%= product.tags.join(', ') %></p>
                <% } %>
            </div>
        </div>
    </div>

    <section id="rating-section">
        <h2 class="section-title">Review</h2>

        <div class="rating-containers">

            <!-- Rating Form -->
            <div class="rating-form" id="rateSection">
                <h3>Rate this Product</h3>
                <div class="rate-stars" id="starSelection">
                    <i class="fa fa-star-o" data-value="1"></i>
                    <i class="fa fa-star-o" data-value="2"></i>
                    <i class="fa fa-star-o" data-value="3"></i>
                    <i class="fa fa-star-o" data-value="4"></i>
                    <i class="fa fa-star-o" data-value="5"></i>
                </div>
                <div class="feedback-container">
                    <textarea id="feedback" placeholder="Write your feedback..." rows="6"></textarea>
                    <div class="upload-container">
                        <label for="imageUpload" class="upload-btn">
                            <i class="fa fa-camera"></i> Add Photos
                        </label>
                        <input type="file" id="imageUpload" accept="image/*" multiple
                            onchange="handleImageUpload(event)" hidden>
                        <div id="imagePreview" class="image-preview"></div>
                    </div>
                </div>
                <button onclick="submitRating()" class="submitbut">Submit</button>
            </div>

            <!-- Review Section -->
            <div class="review-section" id="reviewSection">
                <h3>Customer Reviews</h3>
                <div id="reviewList">
                    <!-- User reviews will appear here -->
                </div>
            </div>
        </div>
    </section>

    <footer id="footer">
        <div class="footer-container">
            <div class="footer-logo">
                <h2>PetVerse</h2>
                <p>Your one-stop destination for all pet needs</p>
            </div>
            <div class="footer-links">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Shop</a></li>
                    <li><a href="#">Services</a></li>
                    <li><a href="#">Events</a></li>
                    <li><a href="#">Contact Us</a></li>
                </ul>
            </div>
            <div class="footer-social">
                <h3>Follow Us</h3>
                <a href="https://facebook.com" target="_blank" class="social-icon">Facebook</a>
                <a href="https://instagram.com" target="_blank" class="social-icon">Instagram</a>
                <a href="https://twitter.com" target="_blank" class="social-icon">Twitter</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 PetVerse. All Rights Reversed</p>
        </div>
    </footer>
    <script src="/js/Products.js"></script>
    <script src="/js/script.js"></script>
    <script src="/js/cart-manager.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize cart manager
            cartManager.initializeCart();
            
            // Add click handler for add to cart button
            const addToCartBtn = document.querySelector('.add-to-cart-btn');
            if (addToCartBtn) {
                addToCartBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    // Check if button is already processing
                    if (this.disabled) return;
                    
                    const productData = document.getElementById('productData');
                    if (productData) {
                        const product = JSON.parse(productData.getAttribute('data-product'));
                        if (product && product._id) {
                            try {
                                // Disable button and show loading state
                                this.disabled = true;
                                const originalText = this.innerHTML;
                                this.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Adding...';
                                
                                const result = await cartManager.addToCart(product._id, 1);
                                if (result.success) {
                                    // Show success feedback
                                    this.innerHTML = '<i class="fa fa-check"></i> Added to Cart!';
                                    this.style.backgroundColor = "#4CAF50";
                                    // Redirect to cart page after short delay
                                    setTimeout(() => {
                                        window.location.href = '/cart';
                                    }, 800);
                                }
                            } catch (error) {
                                console.error('Failed to add to cart:', error);
                                // Show error state
                                this.innerHTML = '<i class="fa fa-times"></i> Failed to Add';
                                this.style.backgroundColor = "#dc3545";
                                
                                // Reset after 1.5 seconds
                                setTimeout(() => {
                                    this.disabled = false;
                                    this.innerHTML = originalText;
                                    this.style.backgroundColor = "";
                                }, 1500);
                                
                                alert(error.message || 'Failed to add item to cart');
                            }
                        }
                    }
                });
            }
            
            // Add click handlers for similar products using event delegation
            const productsContainer = document.querySelector('.products-container');
            if (productsContainer) {
                productsContainer.addEventListener('click', async function(e) {
                    const button = e.target.closest('.product-price');
                    if (button && !button.disabled) {
                        e.preventDefault();
                        e.stopPropagation(); // Prevent navigation when clicking the button
                        
                        const productId = button.getAttribute('data-product-id');
                        if (productId) {
                            try {
                                // Disable button and show loading state
                                button.disabled = true;
                                const originalText = button.textContent;
                                button.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
                                
                                const result = await cartManager.addToCart(productId, 1);
                                if (result.success) {
                                    // Show success feedback
                                    button.innerHTML = '<i class="fa fa-check"></i>';
                                    button.style.backgroundColor = "#4CAF50";
                                    
                                    setTimeout(() => {
                                        button.disabled = false;
                                        button.innerHTML = originalText;
                                        button.style.backgroundColor = "";
                                    }, 1500);
                                }
                            } catch (error) {
                                console.error('Failed to add to cart:', error);
                                // Show error state
                                button.innerHTML = '<i class="fa fa-times"></i>';
                                button.style.backgroundColor = "#dc3545";
                                
                                setTimeout(() => {
                                    button.disabled = false;
                                    button.innerHTML = originalText;
                                    button.style.backgroundColor = "";
                                }, 1500);
                                
                                alert(error.message || 'Failed to add item to cart');
                            }
                        }
                    }
                });
            }
        });
    </script>
    <script src="/js/Buy.js"></script>
    <script>
        // Get all dropdown toggles and menus
        const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
        const dropdownMenus = document.querySelectorAll('.dropdown-menu');

        // Add click event to each dropdown toggle
        dropdownToggles.forEach((toggle, index) => {
            toggle.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent this click from triggering the document click handler

                // Close all other dropdown menus first
                dropdownMenus.forEach((menu, menuIndex) => {
                    if (menuIndex !== index) {
                        menu.classList.remove('show');
                    }
                });
        
            // Toggle the current dropdown menu
                const currentDropdownMenu = this.nextElementSibling;
                currentDropdownMenu.classList.toggle('show');
            });
        });

    // Close all dropdowns when clicking anywhere else on the page
        document.addEventListener('click', function(event) {
            // Check if click is outside of any dropdown
            if (!event.target.closest('.dropdown')) {
            // Close all dropdown menus
                dropdownMenus.forEach(menu => {
                    if (menu.classList.contains('show')) {
                        menu.classList.remove('show');
                    }
                });
            }
        });
    </script>
    <style>
        .slider-container {
            position: relative;
            width: 500px;
        }
        .main-image {
            width: 100%;
            height: 400px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .main-product-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .thumbnail-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }
        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #ddd;
            transition: border-color 0.3s;
        }
        .thumbnail:hover, .thumbnail.active {
            border-color: #007bff;
        }
        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .fullscreen img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .close-btn, .prev-btn, .next-btn {
            position: absolute;
            color: white;
            font-size: 30px;
            cursor: pointer;
            padding: 10px;
        }
        .close-btn {
            top: 20px;
            right: 20px;
        }
        .prev-btn {
            left: 20px;
        }
        .next-btn {
            right: 20px;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mainImage = document.querySelector('.main-product-image');
            const thumbnails = document.querySelectorAll('.thumbnail');
            const fullscreenContainer = document.getElementById('fullscreenContainer');
            const fullscreenImage = document.getElementById('fullscreenImage');
            const closeBtn = document.querySelector('.close-btn');
            const prevBtn = document.querySelector('.prev-btn');
            const nextBtn = document.querySelector('.next-btn');
            let currentImageIndex = 0;

            // Thumbnail click handler
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    currentImageIndex = parseInt(index);
                    updateMainImage();
                    updateThumbnailSelection();
                });
            });

            // Main image click handler for fullscreen
            mainImage.addEventListener('click', function() {
                fullscreenImage.src = this.src;
                fullscreenContainer.style.display = 'flex';
            });

            // Close fullscreen
            closeBtn.addEventListener('click', function() {
                fullscreenContainer.style.display = 'none';
            });

            // Fullscreen navigation
            prevBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                currentImageIndex = (currentImageIndex - 1 + thumbnails.length) % thumbnails.length;
                updateFullscreenImage();
            });

            nextBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                currentImageIndex = (currentImageIndex + 1) % thumbnails.length;
                updateFullscreenImage();
            });

            // Keyboard navigation in fullscreen
            document.addEventListener('keydown', function(e) {
                if (fullscreenContainer.style.display === 'flex') {
                    if (e.key === 'Escape') {
                        fullscreenContainer.style.display = 'none';
                    } else if (e.key === 'ArrowLeft') {
                        currentImageIndex = (currentImageIndex - 1 + thumbnails.length) % thumbnails.length;
                        updateFullscreenImage();
                    } else if (e.key === 'ArrowRight') {
                        currentImageIndex = (currentImageIndex + 1) % thumbnails.length;
                        updateFullscreenImage();
                    }
                }
            });

            function updateMainImage() {
                mainImage.src = thumbnails[currentImageIndex].src;
            }

            function updateFullscreenImage() {
                fullscreenImage.src = thumbnails[currentImageIndex].src;
                updateThumbnailSelection();
            }

            function updateThumbnailSelection() {
                thumbnails.forEach(thumb => thumb.classList.remove('active'));
                thumbnails[currentImageIndex].classList.add('active');
            }
        });
    </script>
</body>

</html>